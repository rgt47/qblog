#!/usr/bin/env bash
Help()
{
echo  The script generates a new security group 
echo  the group name is given with the -s flag. 
echo  ports 22, 80, 3838 and 443 are options. use flags g,i,j,k respectively.  
echo  Script will fail if group name is already in use on EC2. 
echo  reads vpc_id from the environment variables set in .zshrc
echo  example usage for all ports 22, 80, 3838 and 443: 
echo  aws_create_security_group.sh -s power1_app  -g -i  -j  -k 
}
g_flag='false'
i_flag='false'
j_flag='false'
k_flag='false'
l_flag='false'
m_flag='false'

while getopts 'ghijklms:' flag; do
  case "${flag}" in
    h) Help
      exit;;
    g) g_flag='true' ;;
    i) i_flag='true' ;;
    j) j_flag='true' ;;
    k) k_flag='true' ;;
    l) l_flag='true' ;;
    m) m_flag='true' ;;
    s) sg_grp_name=${OPTARG};;
  esac
done

# set defaults
# if $1 (?) the number of options set is 0 then 
#
    #  g_flag='true' ;;
    # k_flag='true' ;;
#
if [ "$#" -eq 0 ]; then
  echo "default settings: 22 and 443. 
    Project name will be set to directory base name"
  base=`basename $PWD`
  sg_grp_name=$base
  g_flag='true'
  k_flag='true'
fi  

echo "sg group name = $sg_grp_name"
aws ec2 create-security-group \
    --group-name $sg_grp_name \
    --description "base security group" \
    --tag-specifications \
    "ResourceType=security-group,Tags=[{Key=Name,Value=$sg_grp_name}]" \
    --vpc-id $vpc_id  > temp.txt
wait    
security_grp=`jq -r .GroupId temp.txt`
wait    
echo "security group ID = $security_grp"

if [ $g_flag  == "true" ]
then
echo "ssh access set "
aws ec2 authorize-security-group-ingress \
    --group-id $security_grp \
    --protocol tcp \
    --port 22 \
    --cidr "0.0.0.0/0"  > /dev/null 2> /dev/null
fi

if [ $k_flag == "true" ]
then
echo "https access set"
aws ec2 authorize-security-group-ingress \
    --group-id $security_grp \
    --protocol tcp \
    --port 443 \
    --cidr "0.0.0.0/0"  > /dev/null 2> /dev/null

fi

if [ $i_flag == "true" ]
then
echo "http access set"
aws ec2 authorize-security-group-ingress \
    --group-id $security_grp \
    --protocol tcp \
    --port 80 \
    --cidr "0.0.0.0/0" > /dev/null 2> /dev/null

fi

if [ $j_flag  == "true" ]
then
echo "shiny access set"
aws ec2 authorize-security-group-ingress \
    --group-id $security_grp \
    --protocol tcp \
    --port 3838 \
    --cidr "0.0.0.0/0" > /dev/null 2> /dev/null

fi


if [ $l_flag  == "true" ]
then
echo "test port 9000 access set"
aws ec2 authorize-security-group-ingress \
    --group-id $security_grp \
    --protocol tcp \
    --port 9000 \
    --cidr "0.0.0.0/0" > /dev/null 2> /dev/null

fi
if [ $m_flag  == "true" ]
then
echo "test port 9001 access set"
aws ec2 authorize-security-group-ingress \
    --group-id $security_grp \
    --protocol tcp \
    --port 9001 \
    --cidr "0.0.0.0/0" > /dev/null 2> /dev/null

fi
