name: Render Blog Analysis (ZZCOLLAB)

on:
  push:
    branches: [main, master]
    paths:
      - 'analysis/**'
      - 'R/**'
      - 'tests/**'
      - 'renv.lock'
      - 'Dockerfile'
      - '.github/workflows/r-package.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'analysis/**'
      - 'R/**'
      - 'tests/**'
      - 'renv.lock'
      - 'Dockerfile'

jobs:
  render-blog:
    runs-on: ubuntu-latest

    steps:
      # ========================================================================
      # STEP 1: Checkout code
      # ========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================================================
      # STEP 2: Set up Docker Buildx (needed for efficient caching)
      # ========================================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========================================================================
      # STEP 3: Build Docker image from Dockerfile
      # ========================================================================
      # This creates the reproducible computational environment with R 4.5.1,
      # system dependencies, and all required C libraries
      - name: Build Docker image
        run: |
          echo "ðŸ³ Building computational environment..."
          docker build -t compendium-env .
          echo "âœ… Docker image built successfully"

      # ========================================================================
      # STEP 4: Restore R packages from renv.lock
      # ========================================================================
      # Installs exact package versions for reproducibility
      - name: Restore R package environment
        run: |
          echo "ðŸ“¦ Restoring R packages from renv.lock..."
          docker run --rm \
            -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            -e RENV_PATHS_CACHE=/tmp/renv-cache \
            compendium-env \
            Rscript -e 'install.packages("renv"); renv::restore()' 2>&1
          echo "âœ… R packages restored"

      # ========================================================================
      # STEP 5: Validate package dependencies (fast shell check)
      # ========================================================================
      # Catches missing packages before expensive tests
      - name: Validate package dependencies
        run: |
          echo "ðŸ” Running validation checks..."
          docker run --rm \
            -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            compendium-env \
            bash modules/validation.sh --no-fix --strict --verbose 2>&1
          echo "âœ… All dependencies validated"

      # ========================================================================
      # STEP 6: Run unit tests (MUST PASS - no continue-on-error)
      # ========================================================================
      # Tests validate that utility functions and components work correctly
      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          docker run --rm \
            -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            compendium-env \
            Rscript -e 'testthat::test_dir("tests/testthat", reporter = "summary")' 2>&1
          echo "âœ… All unit tests passed"

      # ========================================================================
      # STEP 7: Run analysis pipeline (scripts in analysis/scripts/)
      # ========================================================================
      # Execute data processing, model fitting, and figure generation
      - name: Run analysis pipeline
        run: |
          echo "ðŸ“Š Executing analysis scripts..."
          docker run --rm \
            -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            compendium-env \
            bash -c 'for script in analysis/scripts/*.R; do
              if [ -f "$script" ]; then
                echo "  â†’ Running $(basename $script)..."
                Rscript "$script" || exit 1
              fi
            done' 2>&1
          echo "âœ… Analysis pipeline completed"

      # ========================================================================
      # STEP 8: Render Quarto report (MAIN DELIVERABLE)
      # ========================================================================
      # This is the primary output: an HTML report with analysis results
      - name: Render Quarto report
        run: |
          echo "ðŸ“„ Rendering Quarto report..."
          docker run --rm \
            -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            compendium-env \
            Rscript -e 'quarto::quarto_render("analysis/paper/index.qmd", to = "html")' 2>&1
          echo "âœ… Report rendered to HTML"

      # ========================================================================
      # STEP 9: Verify rendered output exists
      # ========================================================================
      # Sanity check that rendering actually produced files
      - name: Verify rendered output
        run: |
          echo "ðŸ”Ž Verifying rendered output..."
          docker run --rm \
            -v ${{ github.workspace }}:/home/analyst/project \
            -w /home/analyst/project \
            compendium-env \
            bash -c 'test -f analysis/paper/index.html && test -s analysis/paper/index.html' 2>&1 && \
          echo "âœ… Rendered HTML report exists and is not empty"

      # ========================================================================
      # STEP 10: Upload rendered report as artifact
      # ========================================================================
      # Makes the rendered report accessible from the GitHub UI
      - name: Upload rendered report
        uses: actions/upload-artifact@v3
        if: success()
        with:
          name: rendered-report
          path: analysis/paper/index.html
          retention-days: 30

      # ========================================================================
      # STEP 11: Create workflow summary
      # ========================================================================
      # Displays results in GitHub UI
      - name: Create success summary
        if: success()
        run: |
          echo "## âœ… Blog Analysis Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The analysis pipeline executed successfully and the blog report was rendered." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker environment built (R 4.5.1)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… R packages restored (renv.lock)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analysis pipeline executed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quarto report rendered to HTML" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reproducibility:**" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image: `rocker/r-ver:4.5.1`" >> $GITHUB_STEP_SUMMARY
          echo "- Package environment: Pinned via renv.lock" >> $GITHUB_STEP_SUMMARY
          echo "- Report artifact: Available in Actions tab" >> $GITHUB_STEP_SUMMARY

      # ========================================================================
      # STEP 12: Create failure summary
      # ========================================================================
      # Help debug if something goes wrong
      - name: Create failure summary
        if: failure()
        run: |
          echo "## âŒ Blog Analysis Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The analysis pipeline encountered an error. Check the logs above to:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **If tests failed:** Fix test cases in \`tests/testthat/\`" >> $GITHUB_STEP_SUMMARY
          echo "2. **If validation failed:** Check library() calls match DESCRIPTION imports" >> $GITHUB_STEP_SUMMARY
          echo "3. **If analysis scripts failed:** Review error messages in analysis/scripts/" >> $GITHUB_STEP_SUMMARY
          echo "4. **If rendering failed:** Check for undefined variables in analysis/paper/index.qmd" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local debugging:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "make docker-run                          # Start interactive session" >> $GITHUB_STEP_SUMMARY
          echo "Rscript tests/testthat/test-utils.R    # Run specific test" >> $GITHUB_STEP_SUMMARY
          echo "Rscript analysis/scripts/01_*.R        # Run specific analysis script" >> $GITHUB_STEP_SUMMARY
          echo "quarto::quarto_render(...)             # Render report manually" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY