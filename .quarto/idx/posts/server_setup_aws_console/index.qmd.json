{"title":"Set up a virtual server on AWS (in anticipation of hosting Shiny apps)","markdown":{"yaml":{"title":" Set up a virtual server on AWS (in anticipation of hosting Shiny apps) ","description":"Detailed steps for setting up a lightweight server on AWS. ","categories":["AWS"],"image":"img/rshiny.png","date":"last-modified"},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n```{r init, include=FALSE}\n\n\n```\n::: column-margin\n![under construction](img/crane.jpg)\n<font size=\"1\"> Photo by\n<a href=\"https://unsplash.com/@nathangwaters?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Nathan\nWaters</a> on\n<a href=\"https://unsplash.com/s/photos/construction?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a>\n</font>\n:::\n\n\n::: {.callout-note}\n## Motivation for this post: \n\nOk! I've got my Shiny app running just the way I want it. Works great! Now, how\ndo I get it up on the web and shared with my collaborators?\n\n:::\n\nAssuming we have a working shiny app, we often next need to also address the\ntask of how to host the app on the web to share with our collaborators. How to\naccomplish this? Below we describe a recommended  process we've found to be\nstraightforward. In this post, we'll describe how to  'spin up' a server on\nAmazon Web Service EC2 using the EC2 console.  In a future post we'll show how,\nthrough the application of Docker, R, Shiny, and Caddy (webserver) functionality\nwe can have a fully functional and secure app available on the web in just a few\nsteps.\n\n# Hosting\n\nNo matter what procedure we use  to host a shiny app (named,  for example, \n `power1_shiny`) online  we'll need to complete the\nfollowing set of tasks one way or another:\n\nPre-launch tasks:\n\n1.  obtain a static IP address\n2.  obtain a domain name (e.g. `rgtlab.org`) and associate it with the IP address\n3.  configure a virtual server. Configuration entails \n   selecting number of CPUs, amount of memory, OS, etc.\n\n4.  define a security model, aka  a firewall for the server\n2.  associate the IP, domain name and firewater with the server \n\nPost-launch tasks:\n\n1.  install and configure a webserver \n5.  obtain and install an SSL certificate (to allow encrypted communication)\n6.  setup an authentication method (password protection for app access)\n7.  configure a reverse proxy method i.e. translate https (port 443) requests to\nShiny (port 3838). This avoids the need to explicitly name the port Shiny is\nlistening on i.e. requiring URLs like\n`https://rgtlab.org:3838/power1_shiny`\n\n::: {.callout-note}\n\n## Not to worry: \n\nAt first glance these  requirements can appear daunting, but on closer\ninspection all can be met with relative ease through the use of right tools. \n:::\n\n\n::: {.callout-note appearance=\"simple\"}\n## Actually ...: \n\nTechnically, if the goal is simply to get the app up on the web, its not\nrequired to have a static IP,  or a domain name,  or a firewall,  or an authentication\nmethod or an SSL certificate, or even a reverse proxy. but if these elements of\nthe process are skipped the server will only be able to communicate via the\nunencrypted HTTP protocol and the site URL will be something like\n111.222.333.444:3838/power1_shiny, and anyone with the URL will be able to reach\nthe site. Also the IP address will change everytime the server is rebooted. \n\n:::\n\n## Select a hosting service \n\n\nThere are a number of cloud based server hosting options to choose from: for\nexample Microsoft Azure, Oracle, Google Cloud, Amazon AWS EC2, Digital Ocean or\nHetzner to name a few. Each has their own approach to setting up a custom\nvirtual server. Several have free or low-cost service tiers available.\n\nIn this post we'll provide a step-by-step description of a process using\nAmazon Web Services Elastic Compute Cloud (AWS EC2) infrastructure. \n\n\nAWS is, in our view, a reasonable choice for setting up a small custom server.\nIts not the cheapest option, but the system is well documented and, in our\nexperience, reliable. \n\nThe first step is to get set up with AWS. \nTo start, open the EC2 console by visiting the URL:\n\n``` sh\n   https://aws.amazon.com/console\n```\n(see margin figure)\n\nIn the console window choose regional service. For us its \"N. California\".\n\n::: column-margin\n![AWS console](img/aws_dash.png)\n:::\n\nNext create an account, or sign in, and once you're logged in navigate to the\nEC2 dashboard.  Its through this dashboard (aka console) that we'll define the\nparameters for the type of server to launch and the mechanisms for communicating\nwith it. We'll refer to these as \"Pre-Launch\" tasks. \n \n\n## AWS Working Environment\n\nAlong with selecting a server we need to set up a working\nenvironment. We recommend setting up the working environment before launching\nthe server, as it saves some back and forth with the console, but the order is\nnot critical. The working environment consists of four\nmain components: \n\n1. A secure shell (ssh) key-pair to allow  remote and secure login to\nthe virtual server once its launched. \n2. A firewall or security model which will restrict server access to only secure\nconnections. The firewall closes off all incoming traffic except\nthrough those ports specifically named.  \n3. A static IP address. A static IP is required for maintaining the link\nbetween the domain name and the server when rebooting. (The default is for the\ninstance/server to be assigned a new IP address each time its rebooted).\nand \n4. A domain name,\nsay `rgtlab.org`. A domain name is not required but will\nfacilitate collaborator access by not needing to use the IP address directly.\n\nThese working environment components are not directly tied to any specific\nserver. In fact, you can define multiple instances of each component. The only\nrequirement is that you pick one of each to associate with each server. \n\n\n### Ssh key pair\n\nIn order to securely communicate with the server we need to exchange an ssh key\npair with AWS. The pair consists of a **private** key and a **public** key.  We can\nidentify an ssh key pair in one of two ways in EC2. Either, generate the pair locally, on our\nworkstation and upload the public key to EC2, or have EC2 generate the key pair\nand download the private key. \n\nFor the first option\nwe create a directory on our workstation to hold the keys and navigate to it,\ne.g. `~/.ssh`.    In the `~/.ssh` directory generate the keys with the command\n\n``` sh\nssh-keygen -m PEM\n```\n\n\"PEM\" defines the key format. More information on public key authentication can\nbe found [here](https://www.ssh.com/academy/ssh/public-key-authentication).  In\nthe interactive dialog  that follows name the key prefix something like\n`power1_app`.  The dialog will ask for a passphrase. You can enter a phrase for an additional\nlevel of security, but its not required.  The `ssh-keygen` program will generate\ntwo files: `power1_app.pem` and `power1_app.pub`\n\n\nTo complete the process return to the  EC2 dashboard  and select `Actions` and\nthen `Import key pair` in the left panel. \nEnter the name `power1_app`\nand select the `Browse` button. \nNavigate to the file \n`power1_app.pub` in the directory `~/.ssh` and \nand select the `Import key pair ` button at the bottom of the page. \n\nFor the second approach select `Create key pair` button in the upper right of\nthe console page.  A form will appears and ask for a name. Enter something like\n`power1_app`.  Select `RSA` for key pair type and `.pem` for key file format.\nThe keys will be created and the private key `power1_app.pem` will be downloaded\nto our local machine  to the and should be place in the`~/.ssh` directory.\nLastly, change the access permissions for the private key with the following\ncommand:\n\n``` sh\nsudo chmod 600 power1_app.pem\n```\n\n### Firewall\n\n\nTo create a firewall click on **Network and Security** settings in the left hand panel.\nChoose **Create security group** and select **Allow SSH traffic** and **Allow\nHTTPS traffic**. \nThis will create a firewall that leaves open only ports 22 and 443, for `ssh` and\n`https` incoming traffic respectively. \nLastly, name the security group something like `power1_firewall`.  \n\n### Static IP address\n\nYou can use the `elastic IP` service to get a static IP. Navigate to **Network\nand Security** again and select **Allocate Elastic IP**. An IP will be assigned\nfrom the EC2 pool of available IPv4 IP addresses e.g. 13.57.139.31. \n\n### Domain Name\n\nTo obtain a dedicated domain name leave the EC2 dashboard and go to  Amazon route 53 service\nto select a domain name and associate it  with our static IP.\n\n\nOnce a domain name is acquired, e.g. `rgtlab.org`,  you can associate it with\nany IP address, static or dynamic. This can be done via the `Route 53 `\nservice. For example, to associate domain name `rgtlab.org` with the elastic IP 13.57.139.31 do the\nfollowing in Route 53:\n\n-   click on `hosted zones` in the side panel\n-   click on `rgtlab.org` in center panel\n-   click on checkbox for `rgtlab.org` type=A line\n-   then click on edit record in right panel\n-   change IP address to the assigned static IP .\n\n::: column-margin\n![](img/ec2a.png)\n:::\n\n## Select and launch instance\n\n2.  From `Quick Start` in the EC2 dashboard select an operating system for the\nserver. We recommend  the `Ubuntu` OS. Ubuntu is a mature Linux distribution\nbased on Debain Linux. Click\nthe `Ubuntu` button. (see margin figure)\n\n-   Name the server, say `power1`\n\n3.  Next choose an instance **type**, e.g. `t2-micro`. Different\n    instance types are combinations of number of processors, memory, \n    storage capacity, and network performance.\n\n4.  select **Configure Instance Details**\n\n5.  choose a Key pair e.g. select `power1_app` from your environment.\n\n6.  Add security group, e.g. use `power1_firewall` from your environment.\n\n7.  choose a storage amount. e.g. enter 30 GB of `EBS General Purpose (SSD) or\n    Magnetic storage`. Thirty GBs is the maximum allowed in the 'Free tier' of\n    servers on AWS. In our experience smaller disk sizes can lead to problems. \n\n8.  click **Launch Instance**\n\nto launch the server.\n\n# Access server\n\nOn your laptop log into server with\n\n``` sh\nssh -i \"~/.ssh/power1_app.pem\" ubuntu@rgtlab.org\n```\n\n# Appendix:  Tip  1\n\n::: {.callout-tip}\n\n## Tip 1.\n\nFor convenience, construct a `config` file in `~/.ssh` as:\n\n``` sh\nHost rgtlab.org #domain name\nHostName 13.57.139.31 # static IP\nUser ubuntu # default user on ubuntu server\nPort 22  # the default port ssh uses\nIdentityFile ~/.ssh/power1_app.pem # private key\n```\n\nthen we can ssh into the new server with the appreviated command\n\n``` sh\nsh> ssh rgtlab.org\n```\n:::\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","number-sections":true,"css":["../../styles.css"],"toc":true,"html-math-method":"katex","include-in-header":{"file":"../../header.html"},"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.313","theme":"tango","license":"CC BY","toc-title":"Table of contents","toc-location":"left","author":[{"name":"Ronald (Ryy) Glenn Thomas","url":"https://rgtlab.org","affiliation":"UCSD","affiliation-url":"https://ucsd.edu","orcid":"0000-0003-1686-4965"}],"citation":true,"comments":{"giscus":{"repo":"rgt47/qblog","repo-id":"R_kgDOH6TO7A","category":"Announcements","category-id":"DIC_kwDOH5G3U84CRUp9","mapping":"pathname","reactions-enabled":true,"loading":"lazy","input-position":"bottom","theme":"light"}},"title":" Set up a virtual server on AWS (in anticipation of hosting Shiny apps) ","description":"Detailed steps for setting up a lightweight server on AWS. ","categories":["AWS"],"image":"img/rshiny.png","date":"last-modified"},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","number-sections":true,"toc":true,"output-file":"index.pdf"},"language":{},"metadata":{"block-headings":true,"margin-left":"30mm","margin-right":"60mm","license":"CC BY","toc-title":"Table of contents","toc-location":"left","author":[{"name":"Ronald (Ryy) Glenn Thomas","url":"https://rgtlab.org","affiliation":"UCSD","affiliation-url":"https://ucsd.edu","orcid":"0000-0003-1686-4965"}],"citation":true,"comments":{"giscus":{"repo":"rgt47/qblog","repo-id":"R_kgDOH6TO7A","category":"Announcements","category-id":"DIC_kwDOH5G3U84CRUp9","mapping":"pathname","reactions-enabled":true,"loading":"lazy","input-position":"bottom","theme":"light"}},"title":" Set up a virtual server on AWS (in anticipation of hosting Shiny apps) ","description":"Detailed steps for setting up a lightweight server on AWS. ","categories":["AWS"],"image":"img/rshiny.png","date":"last-modified"},"extensions":{"book":{}}}}}