{
  "hash": "189bc1ee81088d4b6cec3ea413f723ae",
  "result": {
    "markdown": "---\ntitle: \"Using the AWS command line interface to launch an EC2 server\"\ndescription: \"A single batch program to setup virtual server to host shiny app\"\ncategories: [AWS]\nimage: \"img/rshiny.png\"\n#editor: \n#  markdown: \n#    wrap: 72\nformat:\n  pdf:\n    toc: true\ndate: last-modified\n#date: \"2023-04-12\"\n---\n\n\n\n::: column-margin\n![under construction](img/crane.jpg)\n<font size=\"1\"> Photo by\n<a href=\"https://unsplash.com/@nathangwaters?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Nathan\nWaters</a> on\n<a href=\"https://unsplash.com/s/photos/construction?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a>\n</font>\n:::\n\n# Introduction\n\nIn a separate post ([here](https://focusonr.org/posts/setupaws/)) we discuss\nsetting up a virtual server on Amazon Web Services (AWS) using the interactive\nElastic cloud Compute (EC2) dashboard. While its instructive to use the EC2\nconsole interface to set up a work environment and launch a custom server, it\ncan become a tedious process after the first two or three times. In this post\nwe'll present a bash shell script to perform the same task making use of the AWS\ncommand line interface (CLI). \n\nTo get started:  on your workstation,  configure the aws cli app via the command. \n\nInstructions for installing the AWS CLI can be found\n([here](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html/)).\n\nAlternatively, On Macos use homebrew: \n\n```sh\nzsh> brew install awscli\n```\n\n\n\n```sh\nzsh>  aws configure \n```\n\nThe app will open a dialog asking for your IAM credentials. If you don't have an\nIAM ID \nAppendix 1 [here](#appendix-1) has details on obtaining IAM credentials from your AWS account. \n\n# Scripts\n\nBelow we offer four bash scripts. \n\n1) The first generates a security group for the\nvirtual server, i.e. a firewall. \n\n2) The second creates a key pair to allow\nencrypted ssh communication between the server and your workstation. \n\n3) The third\nscript generates the virtual server taking instance characteristics, firewall,\nstatic IP and domain name as parameters.  \n\n4) The fourth script installs required\nsoftware following server launch. \n\n## Create security group script\n\n```sh\n#!/usr/bin/env bash\n# The script generates a new security group \n# the group name is \"max_restrict\"\n# only ports 22 and 443 are open. \n# to open other ports replicate the last paragraph and change the port number. \n# Will fail if group name \"max_restrict\" in already in use. \n# reads vpc_id from the environment variables set in .zshrc\n#\naws ec2 create-security-group \\\n    --group-name max_restrict \\\n    --description \"most restrictive: ports 22 and 443 only\" \\\n    --tag-specifications \\\n    'ResourceType=security-group,Tags=[{Key=Name,Value=max_restrict}]' \\\n    --vpc-id $vpc_id \nwait    \nexport security_grp=`aws ec2 describe-security-groups | \\\njq -r '.SecurityGroups[] | select(.GroupName==\"max_restrict\").GroupId'`\n\naws ec2 authorize-security-group-ingress \\\n    --group-id $security_grp \\\n    --protocol tcp \\\n    --port 22 \\\n    --cidr \"0.0.0.0/0\" \n\n\naws ec2 authorize-security-group-ingress \\\n    --group-id $security_grp \\\n    --protocol tcp \\\n    --port 443 \\\n    --cidr \"0.0.0.0/0\" \n\n\n```\n\n## Create new key pair with a project name flag\n\n```sh\n\n\n#!/usr/bin/env bash\n#while getopts n: flag\n#do\n    #case \"${flag}\" in\n        #n) key_pair_name=${OPTARG};;\n    #esac\n#done\nbase=`basename $PWD`\nif [ -z \"$1\" ]\nthen\n  key_pair_name=$base\nelse\n  key_pair_name=\"$1\"\nfi\n\necho \"key_pair_name is $key_pair_name\"\n\nread -p \"Continue (y/n)?\" CONT\nif [ \"$CONT\" = \"y\" ]; then\n  echo \"Here we go!\";\nelse\n  echo \"too bad. bye.\"; exit; \nfi\n\ncd ~/.ssh \nrm -f  ~/.ssh/$key_pair_name.pem\naws ec2 create-key-pair  --key-name  $key_pair_name \\\n   --query 'KeyMaterial' --output text > ~/.ssh/$key_pair_name.pem\n\nwait\nchmod 600 ~/.ssh/$key_pair_name.pem\n\n```\n\n\n\n\nstart up script. \n`awscli.sh`\n```sh\n\n\n#!/usr/bin/env bash\nwhile getopts s:t:k:p: flag\ndo\n    case \"${flag}\" in\n        s) size=${OPTARG};;\n        t) type=${OPTARG};;\n        k) key_name=${OPTARG};;\n        p) proj_name=${OPTARG};;\n    esac\ndone\nbase=`basename $PWD`\nif [ -z \"$proj_name\" ]\nthen\n  proj_name=$base\nfi\n\n\n\nif [ -z \"$type\" ]\nthen\n type=\"t2.micro\" \nfi\n\nif [ -z \"$size\" ]\nthen\n  size=30\nfi\n\necho \"Review parameters: \"\necho \"---\"\necho \"proj_name is $proj_name\"\necho \"key_name is $key_name\"\necho \"vpc_id: $vpc_id\";\necho \"subnet_id: $subnet_id\";\necho \"ami_id: $ami_id\";\necho \"security_grp: $security_grp\";\necho \"static_ip: $static_ip\";\necho \"type: $type\";\necho \"size: $size\";\n\nread -p \"Review Notes (y/n)?\" NOTES\nif [ \"$NOTES\" = \"y\" ]; then\necho \"Notes on currect parameters:\"\necho \"security group should be in place already. check on EC2. \nIf not, run ./awscli_create_security.sh. \nKey pair should be in place. check in ~/.ssh. \nIf not run ./create_keypair.sh. \nami id is for ubuntu linux 22.04 LTS. \nIf not what is desired check EC2 list of instances. \";\nelse\n  echo \"I guess you know what you're doing\"; \nfi\n\nread -p \"Continue (y/n)?\" CONT\nif [ \"$CONT\" = \"y\" ]; then\n  echo \"Here we go!\";\nelse\n  echo \"too bad. bye.\"; exit; \nfi\n\n\n#cd ~/.ssh \n#rm -f  ~/.ssh/$proj_name.pem\n#aws ec2 create-key-pair  --key-name  $proj_name \\\n#   --query 'KeyMaterial' --output text > ~/.ssh/$proj_name.pem\n#\n#wait\n#chmod 600 ~/.ssh/$proj_name.pem\n\n\naws ec2 run-instances \\\n    --image-id $ami_id \\\n    --count 1 \\\n    --instance-type $type \\\n    --key-name $proj_name \\\n    --security-group-ids $security_grp \\\n    --subnet-id $subnet_id \\\n    --block-device-mappings \"[{\\\"DeviceName\\\":\\\"/dev/sda1\\\",\\\"Ebs\\\":{\\\"VolumeSize\\\":$size}}]\" \\\n    --tag-specifications \"ResourceType=instance,Tags=[{Key=Name,Value=$proj_name}]\"  \\\n    --user-data file://~/Dropbox/prj/c060/aws_startup.sh\nwait\niid=`aws ec2 describe-instances --filters \"Name=tag:Name,Values=$proj_name\" | \\\n\tjq -r '.Reservations[].Instances[].InstanceId'`\n\naws ec2 associate-address --public-ip $static_ip --instance-id $iid\nwait\nssh -o \"StrictHostKeyChecking no\" rgtlab.org \\\n\t'cd docker_compose_power1_app; sudo docker compose up -d'\n\n```\n\n`aws_startup.sh`\n\n```sh\n\n#!/bin/bash\nsudo apt update\nsudo apt install docker.io -y\nsudo apt install -y curl debian-keyring debian-archive-keyring apt-transport-https\ncurl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | \\\nsudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg\ncurl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | \\\nsudo tee /etc/apt/sources.list.d/caddy-stable.list\nsudo apt update\nsudo apt install caddy -y\n```\n\n::: {.callout-tip}\n\n## Tip 1.\n\nFor convenience, construct a `config` file in `~/.ssh` as:\n\n``` sh\nHost rgtlab.org\nHostName 13.57.139.31 # static IP\nUser ubuntu # default user on ubuntu server\nPort 22  # the default port ssh uses\nIdentityFile ~/.ssh/power1_app_ssh.rsa\n```\n\nthen we can ssh into the new server with\n\n``` sh\nsh> ssh rgtlab.org\n```\n:::\n\nChange the access permissions: `sudo chmod 600 power1ssh.pem` to be more\nrestrictive. \n\n## Appendix 1 Set up AWS IAM {#appendix-1} \n  \nTo initiate batch processing via the AWS cli app. \nSet up `aws` access via the `aws configure` program. \n\nTo get the needed credentials to configure command line `aws`\nuse the AWS IAM service. \n\nDetails follow: \n\nLog into `AWS` console. \n\nSearch for `IAM service`. Navigate to IAM dashboard. \n\nSelect `Users` in left hand panel.  \n\nThen select `Add Users` button (in upper right). \n\nThen enter a `User name` in the form. Click `Next` (lower right)\n\nThen `Create User`. \n\nClick on the user name\n\nIn the page that comes up. Select `Security Credentials` tab (center of page). \n\nUnder `Access Keys` panel click `Create access key` (right side or bottom of\npanel). \n\nClick `Command Line Interface CLI` \n\nand  at the bottom of the page click the checkbox \"I understand...\".\n\nFinally select `Create access key` and \n\nchoose `Download .csv file` (lower right). \n\nNavigate Download screen to local `~/.aws` directory. \n\nClick `Done`\n\nNow in the terminal on your workstation, configure the aws cli app via the command. \n\n```sh\n aws configure \n```\n\nEnter  info from the credentials file just downloaded. After entering the `AWS\nAccess Key ID` and `AWS Secret Access Key` information you are asked for a\nRegion, (my region is `us-west-1`),  and an output format (suggested output format is\n`JSON`). \n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}