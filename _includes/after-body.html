<!-- Fix for Quarto category encoding issue -->
<script>
// Fix category encoding for Quarto listing functionality
(function() {
  function fixAllCategoryEncoding() {
    // Fix sidebar category data-category attributes
    const categoryEls = document.querySelectorAll('.quarto-listing-category .category[data-category]');
    
    categoryEls.forEach((categoryEl) => {
      const category = categoryEl.getAttribute('data-category');
      
      if (category && category !== '') {
        // Check if it contains only base64 characters and proper length
        const isBase64 = /^[A-Za-z0-9+/]*={0,2}$/.test(category) && category.length % 4 === 0;
        
        if (isBase64) {
          try {
            const decoded = decodeURIComponent(atob(category));
            // Verify it decoded to something reasonable (no control characters)
            if (!decoded.match(/^[A-Za-z0-9\s\-,]+$/)) {
              // Invalid encoding, re-encode from original text
              const encodedCategory = btoa(encodeURIComponent(categoryEl.textContent.trim()));
              categoryEl.setAttribute('data-category', encodedCategory);
            }
          } catch (e) {
            // Base64 decode failed, re-encode from original text
            const encodedCategory = btoa(encodeURIComponent(categoryEl.textContent.trim()));
            categoryEl.setAttribute('data-category', encodedCategory);
          }
        } else {
          // Not base64, encode it
          const encodedCategory = btoa(encodeURIComponent(category));
          categoryEl.setAttribute('data-category', encodedCategory);
        }
      }
    });
    
    // Fix listing item data-categories attributes  
    const listingItems = document.querySelectorAll('[data-categories]');
    
    listingItems.forEach((item) => {
      const categories = item.getAttribute('data-categories');
      
      if (categories && categories !== '') {
        // Check if it's already base64 encoded
        try {
          decodeURIComponent(atob(categories));
          // Already encoded and valid
        } catch (e) {
          // Not encoded, fix it
          const encodedCategories = btoa(encodeURIComponent(categories));
          item.setAttribute('data-categories', encodedCategories);
        }
      }
    });
    
    // Fix post-specific category tag click handlers
    const postCategoryTags = document.querySelectorAll('.listing-category[onclick]');
    
    postCategoryTags.forEach((tag) => {
      const categoryText = tag.textContent.trim();
      
      // Replace the onclick handler to use encoded category
      tag.onclick = () => {
        const encodedCategory = btoa(encodeURIComponent(categoryText));
        window.quartoListingCategory(encodedCategory);
        return false;
      };
    });
  }
  
  // Run immediately
  fixAllCategoryEncoding();
  
  // Also run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fixAllCategoryEncoding);
  }
})();
</script>

<!-- PDF view/download button for blog posts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Only add the button on post pages
  if (window.location.pathname.includes('/posts/') && !window.location.pathname.endsWith('/posts/') && !window.location.pathname.endsWith('/posts/index.html')) {
    var currentPath = window.location.pathname;
    // Handle both /posts/name/ and /posts/name/index.html formats
    var pdfPath;
    if (currentPath.endsWith('/')) {
      pdfPath = currentPath + 'index.pdf';
    } else {
      pdfPath = currentPath.replace('.html', '.pdf');
    }

    // Check if PDF exists first
    console.log('Checking for PDF at:', pdfPath);
    fetch(pdfPath, { method: 'HEAD' })
      .then(function(response) {
        console.log('PDF check response:', response.status, response.ok);
        if (response.ok) {
          // PDF exists, show download button
          console.log('PDF exists, showing download button');
          showDownloadButton(pdfPath);
        } else {
          // PDF doesn't exist, generate it on-demand
          console.log('PDF does not exist, generating on-demand');
          generateAndOpenPDF(currentPath, pdfPath);
        }
      })
      .catch(function(error) {
        // Error checking PDF, generate on-demand
        console.log('Error checking PDF:', error);
        generateAndOpenPDF(currentPath, pdfPath);
      });
  }
});

function showDownloadButton(pdfPath) {
  var downloadBtn = document.createElement('div');
  downloadBtn.className = 'pdf-download-button';

  // Get file size if possible
  fetch(pdfPath, { method: 'HEAD' })
    .then(function(response) {
      var size = response.headers.get('Content-Length');
      var sizeText = '';

      if (size) {
        // Convert to MB or KB
        var sizeInMB = size / (1024 * 1024);
        if (sizeInMB >= 1) {
          sizeText = ' (' + sizeInMB.toFixed(1) + ' MB)';
        } else {
          sizeText = ' (' + (size / 1024).toFixed(0) + ' KB)';
        }
      }

      downloadBtn.innerHTML =
        '<div class="alert alert-secondary d-flex align-items-center p-3" role="alert">' +
        '  <a href="' + pdfPath + '" class="btn btn-primary btn-sm me-3" target="_blank">' +
        '    <i class="bi bi-file-pdf me-1"></i> Download PDF' + sizeText +
        '  </a>' +
        '  <span class="small text-muted">View or save a printer-friendly version of this article</span>' +
        '</div>';
    })
    .catch(function() {
      // Basic fallback if we can't get file size
      downloadBtn.innerHTML =
        '<div class="alert alert-secondary d-flex align-items-center p-3" role="alert">' +
        '  <a href="' + pdfPath + '" class="btn btn-primary btn-sm me-3" target="_blank">' +
        '    <i class="bi bi-file-pdf me-1"></i> Download PDF' +
        '  </a>' +
        '  <span class="small text-muted">View or save a printer-friendly version of this article</span>' +
        '</div>';
    });

  // Find where to insert the button (right after the title block)
  var titleBlock = document.querySelector('.quarto-title-meta');
  if (titleBlock) {
    titleBlock.after(downloadBtn);
  }
}

function generateAndOpenPDF(htmlPath, pdfPath) {
  var qmdPath;
  if (htmlPath.endsWith('/')) {
    // Handle /posts/name/ format  
    qmdPath = htmlPath.replace('/posts/', 'posts/') + 'index.qmd';
  } else {
    // Handle /posts/name/index.html format
    qmdPath = htmlPath.replace('/posts/', 'posts/').replace('/index.html', '/index.qmd').replace('.html', '.qmd');
  }

  var generateBtn = document.createElement('div');
  generateBtn.className = 'pdf-download-button';
  generateBtn.innerHTML =
    '<div class="alert alert-secondary d-flex align-items-center p-3" role="alert">' +
    '  <div class="me-3">' +
    '    <i class="bi bi-file-pdf" style="font-size: 1.5rem;"></i>' +
    '  </div>' +
    '  <div class="flex-grow-1">' +
    '    <strong>Generate PDF Version</strong><br>' +
    '    <span class="small text-muted">Click to generate and open a PDF version of this article.</span>' +
    '  </div>' +
    '  <div>' +
    '    <button class="btn btn-primary btn-sm" onclick="generatePDFAndOpen(\'' + qmdPath + '\', \'' + pdfPath + '\', this)">' +
    '      <i class="bi bi-file-pdf me-1"></i>Generate PDF' +
    '    </button>' +
    '  </div>' +
    '</div>';

  // Find where to insert the button (right after the title block)
  var titleBlock = document.querySelector('.quarto-title-meta');
  if (titleBlock) {
    titleBlock.after(generateBtn);
  }
}

function showGenerateButton(htmlPath) {
  var qmdPath;
  if (htmlPath.endsWith('/')) {
    // Handle /posts/name/ format  
    qmdPath = htmlPath.replace('/posts/', 'posts/') + 'index.qmd';
  } else {
    // Handle /posts/name/index.html format
    qmdPath = htmlPath.replace('/posts/', 'posts/').replace('/index.html', '/index.qmd').replace('.html', '.qmd');
  }

  var generateBtn = document.createElement('div');
  generateBtn.className = 'pdf-download-button';
  generateBtn.innerHTML =
    '<div class="alert alert-info d-flex align-items-center p-3" role="alert">' +
    '  <div class="me-3">' +
    '    <i class="bi bi-file-pdf" style="font-size: 1.5rem;"></i>' +
    '  </div>' +
    '  <div class="flex-grow-1">' +
    '    <strong>PDF Version Available</strong><br>' +
    '    <span class="small text-muted">This article can be generated as a PDF for offline reading or printing.</span>' +
    '  </div>' +
    '  <div>' +
    '    <button class="btn btn-outline-primary btn-sm" onclick="copyGenerateCommand(\'' + qmdPath + '\', this)">' +
    '      <i class="bi bi-clipboard me-1"></i>Copy Command' +
    '    </button>' +
    '  </div>' +
    '</div>' +
    '<div class="collapse mt-2" id="generateInstructions">' +
    '  <div class="card card-body bg-light">' +
    '    <small>' +
    '      <strong>To generate PDF:</strong> Run this command in your terminal:<br>' +
    '      <code class="user-select-all" id="generateCommand">./generate_pdf.sh ' + qmdPath + '</code>' +
    '    </small>' +
    '  </div>' +
    '</div>';

  // Find where to insert the button (right after the title block)
  var titleBlock = document.querySelector('.quarto-title-meta');
  if (titleBlock) {
    titleBlock.after(generateBtn);
  }
}

function generatePDFAndOpen(qmdPath, pdfPath, btnElement) {
  console.log('Generating PDF for:', qmdPath);
  
  // Update button to show loading state
  var originalHtml = btnElement.innerHTML;
  btnElement.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Generating...';
  btnElement.disabled = true;
  
  // Make request to generate PDF
  fetch('/generate-pdf', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ qmdPath: qmdPath })
  })
  .then(function(response) {
    if (response.ok) {
      console.log('PDF generation initiated');
      // Wait a moment then try to open the PDF
      setTimeout(function() {
        window.open(pdfPath, '_blank');
        // Reset button
        btnElement.innerHTML = '<i class="bi bi-check me-1"></i>Opened!';
        btnElement.classList.remove('btn-primary');
        btnElement.classList.add('btn-success');
        setTimeout(function() {
          btnElement.innerHTML = originalHtml;
          btnElement.classList.remove('btn-success');
          btnElement.classList.add('btn-primary');
          btnElement.disabled = false;
        }, 2000);
      }, 3000); // Wait 3 seconds for generation
    } else {
      throw new Error('PDF generation failed');
    }
  })
  .catch(function(error) {
    console.log('PDF generation error:', error);
    // Fallback: just render the page to PDF using browser
    window.print();
    // Reset button
    btnElement.innerHTML = originalHtml;
    btnElement.disabled = false;
  });
}

function copyGenerateCommand(qmdPath, btnElement) {
  var command = './generate_pdf.sh ' + qmdPath;
  console.log('Attempting to copy command:', command);
  
  // Try to copy to clipboard
  if (navigator.clipboard && window.isSecureContext) {
    console.log('Using navigator.clipboard');
    navigator.clipboard.writeText(command).then(function() {
      console.log('Command copied successfully');
      showCopyFeedback('Command copied to clipboard!', btnElement);
    }, function(error) {
      console.log('Clipboard copy failed:', error);
      showGenerateInstructions();
    });
  } else {
    // Fallback: show instructions
    console.log('Clipboard not available, showing instructions');
    showGenerateInstructions();
  }
}

function showCopyFeedback(message, btnElement) {
  // Show brief success message
  var originalHtml = btnElement.innerHTML;
  btnElement.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
  btnElement.classList.remove('btn-outline-primary');
  btnElement.classList.add('btn-success');
  
  setTimeout(function() {
    btnElement.innerHTML = originalHtml;
    btnElement.classList.remove('btn-success');
    btnElement.classList.add('btn-outline-primary');
  }, 2000);
}

function showGenerateInstructions() {
  // Toggle instructions visibility
  var instructions = document.getElementById('generateInstructions');
  if (instructions) {
    instructions.classList.toggle('show');
  }
}
</script>

<style>
.pdf-download-button {
  margin-top: 1rem;
  margin-bottom: 1rem;
}
</style>